<!DOCTYPE html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Gamma (40Hz) light and sound stimulation">

    <title>Gamma (40Hz) stimulation</title>
    <style>
        :root {
            color: orange;
            background: midnightblue;
        }

        #gamma-off {
            display: none;
        }

        .gamma-on #gamma-off {
            display: unset;
        }

        #gamma-on {
            display: unset;
        }

        .gamma-on #gamma-on {
            display: none;
        }

        #light {
            position: fixed;
            top: 110px;
            bottom: 0;
            width: 100vw;
            background-color: yellowgreen;
            background-position: center;
            background-size: cover;
        }

        #light-gamma {
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background-color: black;
            opacity: 0;
        }

        .NOgamma-on.use-light #light-gamma {
            animation-name: light;
            animation-duration: 0.025s;
            NOanimation-duration: 0.25s;
            NOanimation-duration: 2.25s;
            animation-iteration-count: infinite;
        }

        @keyframes light {
            0% {
                opacity: 0
            }

            50% {
                opacity: 1
            }
        }

        #controls {
            display: flex;
            gap: 20px;
        }

        #main-h1 {
            position: relative;
        }

        #info-button {
            position: absolute;
            top: 0;
            right: 0;
            background-color: blue;
            color: white;
            display: inline-flex;
            height: 100%;
            aspect-ratio: 1 / 1;
            justify-content: center;
            border-radius: 50%;
            border: 2px solid white;
        }

        #info-button a {
            color: white;
            text-decoration: none;
        }
    </style>

</head>

<body>

    <h1 id="main-h1">
        Gamma (40Hz)
        <span id="info-button" title="Display information">
            <a href="https://lborgman.github.io/gamma/">i</a>
        </span>
    </h1>

    <div id="controls">
        <button id="btn-start-stop">
            <span id="gamma-on"> Start </span>
            <span id="gamma-off"> Stop </span>
        </button>
        <label>Sound<input id="use-sound" type="checkbox" checked></label>
        <label>Light<input id="use-light" type="checkbox"></label>
        <span>(<label>Image<input id="use-image" type="checkbox"></label>)</span>
    </div>

    <div id="light">
        <div id="light-gamma"></div>
    </div>


    <script>
        /** @typedef {number} frequency */
        /** @typedef {number} gain */
        /** @typedef {{frequency: frequency, gain: gain }} oscTemplate */

        const freqInit = 40;
        const gain = 1;
        let osc;

        let gammaIsOn = false;
        let useLight = false;
        let useImage = false;

        const arrImages = [
            "https://lh3.googleusercontent.com/pw/AP1GczPZHjrjXOnXQeennfbtWiOdRgNY_NpjI00SpKjO47LHm4lN4NauUVNKb69x8en1n90poUiZNPSN3PVG7mXSjluMB_8ZP6FIC4VzOcFTBsluyaC9UdG9YQMpczNdKHokU7cxY01DoxeT5e7EVz5RHX2ZUw=w1592-h1198-s-no-gm?authuser=0",
            "https://lh3.googleusercontent.com/pw/AP1GczODrndM_An2xnNqehASvlH5IxQ94q7RP4bXGxu7bcSshuk6sCuBxG-dVk-Ym5nQW6RUjWtYbzAUrogBWFqVB1VFWksdOD8aNZLKURvpHhK_xhbyaWq8Hz-VEcrF54f3Dc4xN3zVKONA1Zy8NQWe4Tj6Zg=w1592-h1198-s-no-gm?authuser=0",
            "https://lh3.googleusercontent.com/pw/AP1GczO54Xvvtr_w91FRnSy0ZHGiWma3abAsT_b9nrHLMKJhOEQOgDNFxHKAuImVleY5pfRoPFpeLQz1E5Y1rowNLyVsmAVVxsMagPIip8euioi8FIHpIvjSPZuQ-5yxIAlXNkd-x2sBIxkI2D5ut5bTozl3wQ=w1592-h1198-s-no-gm?authuser=0",
            "https://lh3.googleusercontent.com/pw/AP1GczOaiq5PkXHrY5xZipGPamQLt3YKEQD4_uO9Ky2XF81UgH4X2KpONGPUOQCitKVupyA6WtrjmjBmbyZPDgrUtqRaeKlx4Vt0jLBDxo5spLYdgzmA2_wpTPXj6q6KD0SYeXPSL7Q5k_QQA3WRl4ZmNyq2Pw=w1592-h1198-s-no-gm?authuser=0",
            "https://lh3.googleusercontent.com/pw/AP1GczNFLIS5elLTIhT9ANSVPx1O7AwH-sM3dPw6cocwZQ5Aqm6vW7Z_VMrbPMZ1-0rwUsJbM6fcLSvfmNojiGoHhBF7L4nNHvpq8dH83KckTpgX0Xq8n_1cqvnzRUcnmUX-SeUmGvvdJLvm3H8jdaau_YbpkA=w1592-h1198-s-no-gm?authuser=0",
            "https://lh3.googleusercontent.com/pw/AP1GczN9cSBk77HAH2EMpy2Kl2fL1YJBqM5vp64CW_WYtoBbK6o-4tkePMAUXOvH_qVoEGCiku5yQoikfy38d1d3GD-bMTqFBLhS9Syr1yff_XGwvuu2SrjQTjslFPb0WvE67OAOfxLUi4w-RCycInU50Zix4Q=w1592-h1198-s-no-gm?authuser=0",
            "https://lh3.googleusercontent.com/pw/AP1GczN4V8bTf-dqvlqDTH9pvzMytuFvajlNaZjwq2nPe3wkpkNaEzY0G1xV5iFETgJ3ihlJ6-s3mOf5XOdQUInlyCWxBIqn3UmgQa3C09-7aFzcR6KJ0KY_PrbyiJ4-64lhPNsUUBLlUwTQBaw446ZYWPyTKw=w1592-h1198-s-no-gm?authuser=0",
        ];
        let bgImg = arrImages[0];


        const eltLight = document.getElementById("light");
        function setBackgroundImage() { eltLight.style.backgroundImage = `url(${bgImg})`; }
        function removeBackgroundImage() { eltLight.style.backgroundImage = null; }

        const eltLightGamma = document.getElementById("light-gamma");

        const btnStartStop = document.getElementById("btn-start-stop");
        btnStartStop.addEventListener("click", evt => { funBtnStartStop(); });

        const chkSound = document.getElementById("use-sound");
        chkSound.addEventListener("change", evt => { funChkSound(); });

        const chkLight = document.getElementById("use-light");
        chkLight.addEventListener("change", evt => { funChkLight(); });

        const chkImage = document.getElementById("use-image");
        chkImage.addEventListener("change", evt => { funChkImage(); });


        function funChkImage() {
            const checkedNow = chkImage.checked;
            console.log({ checkedNow });
            useImage = checkedNow;
            if (checkedNow) {
                setBackgroundImage();
            } else {
                removeBackgroundImage();
            }
        }

        function funChkSound() {
            if (chkSound.checked) {
                const gammaIsOn = document.documentElement.classList.contains("gamma-on");
                if (gammaIsOn) { startSound(); }
            } else {
                stopSound();
            }
        }


        function funBtnStartStop() {
            gammaIsOn = !document.documentElement.classList.contains("gamma-on");
            document.documentElement.classList.toggle("gamma-on");
            if (!gammaIsOn) {
                stopSound();
            } else {
                if (chkSound.checked) {
                    startSound();
                }
                animateLight();
            }
        }

        function funChkLight() {
            useLight = chkLight.checked;
            if (useLight) {
                document.documentElement.classList.add("use-light");
            } else {
                document.documentElement.classList.remove("use-light");
            }
            console.log({ useLight });
        }

        function activateLight() {
            document.documentElement.classList.add("light-gamma");
        }
        function deactivateLight() {
            document.documentElement.classList.remove("light-gamma");
        }
        let lastDark = false;
        function animateLight() {
            if (!gammaIsOn) return;
            const part = document.timeline.currentTime % 25;
            let dark = part < 12;
            if (!useLight) dark = true;
            if (lastDark != dark) {
                eltLightGamma.style.opacity = dark ? "0" : "1";
                lastDark = dark;
            }
            requestAnimationFrame(
                () => {
                    animateLight();
                });
        }


        function stopSound() {
            osc?.stop();
            osc = undefined;
        }
        function startSound() {
            const ctxAudio = new AudioContext();
            osc = ctxAudio.createOscillator();
            const amp = ctxAudio.createGain();
            const startTime = ctxAudio.currentTime;

            osc.frequency.setValueAtTime(freqInit, startTime);
            amp.gain.setValueAtTime(gain, startTime);

            osc.connect(amp);
            amp.connect(ctxAudio.destination);

            osc.start();
        }

    </script>
</body>