<!DOCTYPE html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Gamma (40hz) light and sound stimulation">

    <title>Gamma (40hz) stimulation</title>
    <style>
        :root {
            color: orange;
            background: midnightblue;
        }

        #gamma-off {
            display: none;
        }

        .gamma-on #gamma-off {
            display: unset;
        }

        #gamma-on {
            display: unset;
        }

        .gamma-on #gamma-on {
            display: none;
        }

        #light {
            position: fixed;
            top: 110px;
            bottom: 0;
            width: 100vw;
            background-color: yellowgreen;
        }

        #light-gamma {
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background-color: black;
            NOoutline: 1px dotted red;
        }

        .gamma-on.use-light #light-gamma {
            animation-name: light;
            animation-duration: 0.025s;
            NOanimation-duration: 0.25s;
            animation-duration: 2.25s;
            animation-iteration-count: infinite;
        }

        @keyframes light {
            0% {
                opacity: 0
            }

            50% {
                opacity: 1
            }
        }

        #controls {
            display: flex;
            gap: 20px;
        }
    </style>

</head>

<body>

    <h1>Gamma (40hz) stimulation</h1>

    <div id="controls">
        <button id="btn-start-stop">
            <span id="gamma-on"> Start </span>
            <span id="gamma-off"> Stop </span>
        </button>
        <label>Sound: <input id="use-sound" type="checkbox"> </label>
        <label>Light: <input id="use-light" type="checkbox"> </label>
    </div>

    <div id="light">
        <div id="light-gamma"></div>
    </div>


    <script>
        /** @typedef {number} frequency */
        /** @typedef {number} gain */
        /** @typedef {{frequency: frequency, gain: gain }} oscTemplate */

        const freqInit = 40;
        const gain = 1;
        let osc;

        // const eltLight = document.getElementById("light-gamma");
        // eltLight.animate(keyframe,)

        const chkSound = document.getElementById("use-sound")
        chkSound.addEventListener("change", evt => {
            if (chkSound.checked) {
                const gammaIsOn = document.documentElement.classList.contains("gamma-on");
                if (gammaIsOn) { startSound(); }
            } else {
                stopSound();
            }
        });

        const btnStartStop = document.getElementById("btn-start-stop");
        btnStartStop.addEventListener("click", evt => {
            const gammaIsOn = document.documentElement.classList.contains("gamma-on");
            document.documentElement.classList.toggle("gamma-on");
            if (gammaIsOn) {
                stopSound();
            } else {
                if (chkSound.checked) {
                    startSound();
                }
            }

            // startOrStopAudio();
        });


        const chkLight = document.getElementById("use-light")
        chkLight.addEventListener("change", evt => {
            const useLight = chkLight.checked;
            if (useLight) {
                document.documentElement.classList.add("use-light");
            } else {
                document.documentElement.classList.remove("use-light");
            }
            console.log({ useLight });
        });

        function activateLight() {
            document.documentElement.classList.add("light-gamma");
        }
        function deactivateLight() {
            document.documentElement.classList.remove("light-gamma");
        }
        function startOrStopAudio() {
            const soundIsOn = document.documentElement.classList.contains("sound-is-on");
            console.log("starting or stopping sound...", { soundIsOn });
            document.documentElement.classList.toggle("sound-is-on");


            if (!soundIsOn) {
                startSound();
            } else {
                stopSound();
            }
        }
        function stopSound() {
            osc?.stop();
            osc = undefined;
        }
        function startSound() {
            const ctxAudio = new AudioContext();
            osc = ctxAudio.createOscillator();
            const amp = ctxAudio.createGain();
            const startTime = ctxAudio.currentTime;

            osc.frequency.setValueAtTime(freqInit, startTime);
            amp.gain.setValueAtTime(gain, startTime);

            osc.connect(amp);
            amp.connect(ctxAudio.destination);

            osc.start();
        }

    </script>
</body>