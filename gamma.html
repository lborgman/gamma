<!DOCTYPE html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Gamma (40Hz) light and sound stimulation">

    <title>Gamma (40Hz) stimulation</title>
    <style>
        :root {
            color: orange;
            background: midnightblue;
        }

        #gamma-off {
            display: none;
        }

        .gamma-on #gamma-off {
            display: unset;
        }

        #gamma-on {
            display: unset;
        }

        .gamma-on #gamma-on {
            display: none;
        }

        #light {
            position: fixed;
            top: 110px;
            bottom: 0;
            width: 100vw;
            background-color: yellowgreen;
            background-position: center;
            background-size: cover;
        }

        #light-gamma {
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background-color: black;
            opacity: 0;
        }

        .NOgamma-on.use-light #light-gamma {
            animation-name: light;
            animation-duration: 0.025s;
            NOanimation-duration: 0.25s;
            NOanimation-duration: 2.25s;
            animation-iteration-count: infinite;
        }

        @keyframes light {
            0% {
                opacity: 0
            }

            50% {
                opacity: 1
            }
        }

        #controls {
            display: flex;
            gap: 20px;
        }

        #main-h1 {
            position: relative;
        }

        #settings-button {
            padding: 0;
            border: none;
            color: goldenrod;
            background: none;
            aspect-ratio: 1 / 1;
            height: 1.1em;
            font-size: 1.3em;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            margin-left: 20px;
        }

        #dialog-settings {
            min-width: 200px;
        }

        #dialog-settings::backdrop {
            background-color: black;
            opacity: 0.6;
        }

        #dialog-settings label {
            display: flex;
            gap: 10px;
            height: 32px;
            align-items: center;
        }

        #settings-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        #inp-freq {
            width: 3em;
        }

        #inp-color {
            height: 100%;
            aspect-ratio: 1 / 1;
            border: none;
        }



        #info-button {
            position: absolute;
            top: 0;
            right: 0;
            background-color: blue;
            color: white;
            display: inline-flex;
            height: 100%;
            aspect-ratio: 1 / 1;
            justify-content: center;
            border-radius: 50%;
            border: 2px solid white;
            scale: 0.6;
        }

        #info-button a {
            color: white;
            text-decoration: none;
        }

        #slow-screen {
            position: absolute;
            top: -30px;
            left: 0px;
            background-color: red;
            color: yellow;
            padding: 4px;
            border-radius: 4px;
            transition: opacity 3s;
            display: inline-grid;
        }
    </style>

</head>

<body>

    <h1 id="main-h1">
        Gamma (40Hz)
        <span id="info-button" title="Display information">
            <a href="https://lborgman.github.io/gamma/">i</a>
        </span>
    </h1>

    <div id="controls">
        <button id="btn-start-stop">
            <span id="gamma-on"> Start </span>
            <span id="gamma-off"> Stop </span>
        </button>
        <label>Sound<input id="use-sound" type="checkbox" checked></label>
        <label>Light<input id="use-light" type="checkbox"></label>
        <!-- <span >(<label>Image<input id="use-image" type="checkbox"></label>)</span> -->
        <button id="settings-button" title="Settings">âš™</button>
    </div>

    <div id="light">
        <div id="light-gamma"></div>
    </div>

    <dialog id="dialog-settings">
        <p style="background:yellow; color:red">Nearly ready...</p>
        <h2>Settings</h2>
        <p>
            <label>Frequency: <input id="inp-freq" type="number"></label>
        </p>
        <p>
            <label>Color: <input id="inp-color" type="color"></label>
        </p>
        <p id="settings-buttons">
            <button autofocus id="btn-close-settings">Close</button>
        </p>
    </dialog>

    <script type="module">
        /** @typedef {number} frequency */
        /** @typedef {number} gain */
        /** @typedef {{frequency: frequency, gain: gain }} oscTemplate */

        const modLocalSettings = await import("./js/local-settings.js");
        const STORING_PREFIX = "gamma-";
        class OurLocalSetting extends modLocalSettings.LocalSetting {
            constructor(key, defaultValue) {
                super(STORING_PREFIX, key, defaultValue);
            }
        }

        const settingFrequency = new OurLocalSetting("frequency", 40);
        const settingBGcolor = new OurLocalSetting("bgcolor", "yellowgreen");
        const settingSound = new OurLocalSetting("sound", true);
        const settingLight = new OurLocalSetting("sound", false);

        let freq40 = settingFrequency.value;

        const gain = 1;
        let osc;

        let gammaIsOn = false;
        let useLight = false;
        let useImage = false;

        const arrImages = [
            "https://lh3.googleusercontent.com/pw/AP1GczPZHjrjXOnXQeennfbtWiOdRgNY_NpjI00SpKjO47LHm4lN4NauUVNKb69x8en1n90poUiZNPSN3PVG7mXSjluMB_8ZP6FIC4VzOcFTBsluyaC9UdG9YQMpczNdKHokU7cxY01DoxeT5e7EVz5RHX2ZUw=w1592-h1198-s-no-gm?authuser=0",
            "https://lh3.googleusercontent.com/pw/AP1GczODrndM_An2xnNqehASvlH5IxQ94q7RP4bXGxu7bcSshuk6sCuBxG-dVk-Ym5nQW6RUjWtYbzAUrogBWFqVB1VFWksdOD8aNZLKURvpHhK_xhbyaWq8Hz-VEcrF54f3Dc4xN3zVKONA1Zy8NQWe4Tj6Zg=w1592-h1198-s-no-gm?authuser=0",
            "https://lh3.googleusercontent.com/pw/AP1GczO54Xvvtr_w91FRnSy0ZHGiWma3abAsT_b9nrHLMKJhOEQOgDNFxHKAuImVleY5pfRoPFpeLQz1E5Y1rowNLyVsmAVVxsMagPIip8euioi8FIHpIvjSPZuQ-5yxIAlXNkd-x2sBIxkI2D5ut5bTozl3wQ=w1592-h1198-s-no-gm?authuser=0",
            "https://lh3.googleusercontent.com/pw/AP1GczOaiq5PkXHrY5xZipGPamQLt3YKEQD4_uO9Ky2XF81UgH4X2KpONGPUOQCitKVupyA6WtrjmjBmbyZPDgrUtqRaeKlx4Vt0jLBDxo5spLYdgzmA2_wpTPXj6q6KD0SYeXPSL7Q5k_QQA3WRl4ZmNyq2Pw=w1592-h1198-s-no-gm?authuser=0",
            "https://lh3.googleusercontent.com/pw/AP1GczNFLIS5elLTIhT9ANSVPx1O7AwH-sM3dPw6cocwZQ5Aqm6vW7Z_VMrbPMZ1-0rwUsJbM6fcLSvfmNojiGoHhBF7L4nNHvpq8dH83KckTpgX0Xq8n_1cqvnzRUcnmUX-SeUmGvvdJLvm3H8jdaau_YbpkA=w1592-h1198-s-no-gm?authuser=0",
            "https://lh3.googleusercontent.com/pw/AP1GczN9cSBk77HAH2EMpy2Kl2fL1YJBqM5vp64CW_WYtoBbK6o-4tkePMAUXOvH_qVoEGCiku5yQoikfy38d1d3GD-bMTqFBLhS9Syr1yff_XGwvuu2SrjQTjslFPb0WvE67OAOfxLUi4w-RCycInU50Zix4Q=w1592-h1198-s-no-gm?authuser=0",
            "https://lh3.googleusercontent.com/pw/AP1GczN4V8bTf-dqvlqDTH9pvzMytuFvajlNaZjwq2nPe3wkpkNaEzY0G1xV5iFETgJ3ihlJ6-s3mOf5XOdQUInlyCWxBIqn3UmgQa3C09-7aFzcR6KJ0KY_PrbyiJ4-64lhPNsUUBLlUwTQBaw446ZYWPyTKw=w1592-h1198-s-no-gm?authuser=0",
        ];
        let bgImg = arrImages[0];

        const objLight = {}
        function resetObjLight() {
            objLight.msStart = Date.now();
            objLight.osc = 0;
            objLight.reqAF = 0;
        }
        let justFlippedImage = false;
        let slowScreen = false;
        function needFlipLight() {
            if (slowScreen) return;
            objLight.reqAF++;
            if (objLight.reqAF > 200) {
                if (objLight.reqAF < objLight.osc) {
                    console.log("%cSLOW SCREEN", "color:red; font-size: 1.3em;", { objLight });
                    slowScreen = true;
                    stopLight();
                    chkLight.checked = false;
                    chkLight.disabled = true;
                    // chkImage.checked = false;
                    // chkImage.disabled = true;
                    // const lblImage = chkImage.closest("label");
                    // lblImage.style.opacity = 0.5;

                    const lblLight = chkLight.closest("label");
                    lblLight.style.position = "relative";
                    const eltSlow = document.createElement("div");
                    eltSlow.id = "slow-screen";
                    eltSlow.textContent = "Slow screen";
                    setTimeout(() => {
                        eltSlow.style.opacity = 0;
                        lblLight.style.opacity = 0.5;
                    }, 4000);
                    lblLight.appendChild(eltSlow);
                    return;
                }
            }
            const msNow = Date.now();
            const ms = msNow - objLight.msStart;
            const msOsc2 = 0.5 * 1000 / freq40;
            const osc2 = Math.floor(ms / msOsc2);
            const diffOsc = osc2 - objLight.osc;
            if (diffOsc == 0) { return false; }
            objLight.osc = osc2;
            return true;
            /*
                        // console.log("diffOsc", diffOsc);
                        switch (diffOsc) {
                            case 1:
                            case 2:
                                objLight.osc = osc;
                                return true;
                            case 0:
                                return false;
                            default:
                                console.error({ diffOsc, objLight, msNow, ms, justFlippedImage });
                                if (justFlippedImage) {
                                    justFlippedImage = false;
                                    objLight.osc = osc;
                                    return true;
                                }
                                useLight = false;
                                chkLight.checked = false; // FIX-ME: move this function
                                return false;
                        }
            */
        }


        const eltLight = document.getElementById("light");
        function setFlashColor() { eltLight.style.backgroundColor = settingBGcolor.value; }
        setFlashColor();

        function setBackgroundImage() { eltLight.style.backgroundImage = `url(${bgImg})`; }
        function removeBackgroundImage() { eltLight.style.backgroundImage = null; }

        const eltLightGamma = document.getElementById("light-gamma");

        const btnStartStop = document.getElementById("btn-start-stop");
        btnStartStop.addEventListener("click", evt => { funBtnStartStop(); });

        const chkSound = document.getElementById("use-sound");
        settingSound.bindToInput(chkSound);
        chkSound.addEventListener("change", evt => { funChkSound(); });

        const chkLight = document.getElementById("use-light");
        settingLight.bindToInput(chkLight);
        chkLight.addEventListener("change", evt => { funChkLight(); });

        const chkImage = document.getElementById("use-image");
        chkImage?.addEventListener("change", evt => { funChkImage(); });

        const btnSettings = document.getElementById("settings-button");
        btnSettings.addEventListener("click", evt => {
            dialogSettings();
        });

        function dialogSettings() {

            const inpFreq = document.getElementById("inp-freq")
            settingFrequency.bindToInput(inpFreq);

            const inpColor = document.getElementById("inp-color");
            settingBGcolor.bindToInput(inpColor);
            inpColor.addEventListener("change", evt => { setFlashColor(); });

            const eltDialog = document.getElementById("dialog-settings");
            const btnClose = document.getElementById("btn-close-settings");
            btnClose.addEventListener("click", evt => { eltDialog.close(); });

            // stopSound start-stop
            eltDialog.showModal();
        }

        function funChkImage() {
            justFlippedImage = true;
            const checkedNow = chkImage.checked;
            console.log({ checkedNow });
            useImage = checkedNow;
            if (checkedNow) {
                setBackgroundImage();
            } else {
                removeBackgroundImage();
            }
        }

        function funChkSound() {
            if (chkSound.checked) {
                const gammaIsOn = document.documentElement.classList.contains("gamma-on");
                if (gammaIsOn) { startSound(); }
            } else {
                stopSound();
            }
        }


        function funBtnStartStop() {
            gammaIsOn = !document.documentElement.classList.contains("gamma-on");
            document.documentElement.classList.toggle("gamma-on");
            if (!gammaIsOn) {
                stopSound();
                stopLight();
            } else {
                if (chkSound.checked) {
                    startSound();
                }
                if (chkLight.checked) {
                    startLight();
                }
            }
        }
        function startLight() {
            useLight = true;
            resetObjLight();
            animateLight();
        }
        function stopLight() {
            useLight = false;
            eltLightGamma.style.opacity = "0";
        }

        function funChkLight() {
            useLight = chkLight.checked;
            if (useLight) {
                document.documentElement.classList.add("use-light");
                startLight();
            } else {
                document.documentElement.classList.remove("use-light");
                stopLight();
            }
            // console.log({ useLight });
        }

        function activateLight() {
            document.documentElement.classList.add("light-gamma");
        }
        function deactivateLight() {
            document.documentElement.classList.remove("light-gamma");
        }
        let lastDark = false;
        function animateLight() {
            if (!gammaIsOn) return;
            if (!useLight) return;
            // const part = document.timeline.currentTime % 25;
            // let dark = part < 12;
            // if (!useLight) dark = true;
            if (needFlipLight()) {
                // if (lastDark != dark) {
                // eltLightGamma.style.opacity = dark ? "0" : "1";
                // lastDark = dark;
                // }
                eltLightGamma.style.opacity = lastDark ? "0" : "1";
                lastDark = !lastDark;
            }
            requestAnimationFrame(
                () => {
                    animateLight();
                });
        }


        function stopSound() {
            osc?.stop();
            osc = undefined;
        }
        function startSound() {
            const ctxAudio = new AudioContext();
            osc = ctxAudio.createOscillator();
            const amp = ctxAudio.createGain();
            const startTime = ctxAudio.currentTime;

            osc.frequency.setValueAtTime(freq40, startTime);
            amp.gain.setValueAtTime(gain, startTime);

            osc.connect(amp);
            amp.connect(ctxAudio.destination);

            osc.start();
        }

    </script>
</body>